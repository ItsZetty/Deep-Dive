# Gap Lock and NextKey Lock

κ°­ λ½κ³Ό λ„¥μ¤νΈν‚¤ λ½μ— λ€ν•΄ μ•μ•„λ³΄κΈ° μ „μ— μ°μ„  ν¬ν…€ λ¦¬λ“μ— λ€ν•΄ μ•μ•„λ³΄κ² μµλ‹λ‹¤.

## π¤·π»β€β™‚οΈ Phantom Readλ€ λ¬΄μ—‡μΈκ°€μ”?
Phantom Readλ” νΈλμ­μ…μ΄ λ™μΌν• μ΅°κ±΄μ μΏΌλ¦¬λ¥Ό λ°λ³µ μ‹¤ν–‰ν•  λ•, λ‚μ¤‘μ— μ‹¤ν–‰λ μΏΌλ¦¬μ—μ„ μ²μμ—λ” μ΅΄μ¬ν•μ§€ μ•μ•λ μƒλ΅μ΄ ν–‰μ΄ λ‚νƒ€λ‚λ” ν„μƒμ„ λ§ν•©λ‹λ‹¤. μ΄λ” μ£Όλ΅ μ½κΈ° μΌκ΄€μ„±(Read Consistency)μ„ μ μ§€ν•λ” κ³Όμ •μ—μ„ λ°μƒν•  μ μλ” λ¬Έμ λ΅, λ°μ΄ν„°μ μ‚½μ…μ΄λ‚ μ‚­μ κ°€ λ‹¤λ¥Έ νΈλμ­μ…μ— μν•΄ μ΄λ£¨μ–΄μ§ λ• λ°μƒν•©λ‹λ‹¤.

```sql
-- νΈλμ­μ… A μ‹μ‘
START TRANSACTION;

-- νΈλμ­μ… A μ²« λ²μ§Έ μ΅°ν
SELECT * FROM orders WHERE amount > 150;

-- νΈλμ­μ… B μ‹μ‘
START TRANSACTION;

-- νΈλμ­μ… B μƒλ΅μ΄ ν–‰ μ‚½μ…
INSERT INTO orders (customer_id, amount) VALUES (4, 250);

-- νΈλμ­μ… B μ»¤λ°‹
COMMIT;

-- λ™μΌν• μ΅°κ±΄μΌλ΅ νΈλμ­μ… A λ‘ λ²μ§Έ μ΅°νμ‹, νΈλμ­μ… Aμ μ²« λ²μ§Έ μ΅°νμ—λ” μ΅΄μ¬ν•μ§€ μ•λ, νΈλμ­μ… Bμ—μ„ μ‚½μ…λ μƒλ΅μ΄ ν–‰μ΄ ν•¨κ» μ΅°νλλ‹¤.
-- λ‹¨, MVCCλ¥Ό μ§€μ›ν•λ” κ²½μ° ν•΄λ‹Ή μΌ€μ΄μ¤μ—μ„ ν¬ν…€ λ¦¬λ“κ°€ λ°μƒν•μ§€ μ•λ”λ‹¤.
SELECT * FROM orders WHERE amount > 150;
```

## π¤·π»β€β™‚οΈ Gap Lockμ΄λ€ λ¬΄μ—‡μΈκ°€μ”?
κ°­ λ½μ€ νΉμ • μΈλ±μ¤ κ°’ μ‚¬μ΄μ κ³µκ°„μ„ μ κ·Έλ” λ½μ…λ‹λ‹¤. 

κΈ°μ΅΄ λ μ½”λ“ κ°„μ κ°„κ²©μ„ λ³΄νΈν•μ—¬ μƒλ΅μ΄ λ μ½”λ“μ μ‚½μ…μ„ λ°©μ§€ν•©λ‹λ‹¤. κ°­ λ½μ€ λ²”μ„ λ‚΄μ— νΉμ • λ μ½”λ“κ°€ μ΅΄μ¬ν•μ§€ μ•μ„ λ• μ μ©λ©λ‹λ‹¤. νΈλμ­μ…μ΄ νΉμ • λ²”μ„ λ‚΄μ—μ„ λ°μ΄ν„°μ μ‚½μ…μ„ λ§‰μ•„ ν¬ν…€ μ½κΈ°(Phantom Read) ν„μƒμ„ λ°©μ§€ν•©λ‹λ‹¤. 

μλ¥Ό λ“¤μ–΄, μΈλ±μ¤ κ°’ 10κ³Ό 20 μ‚¬μ΄μ κ°­μ„ μ κ·Έλ©΄ μ΄ λ²”μ„ λ‚΄μ— μƒλ΅μ΄ λ μ½”λ“ 15λ¥Ό μ¶”κ°€ν•  μ μ—†μµλ‹λ‹¤.

```sql
-- id 1, 3, 5κ°€ μ €μ¥λ orders ν…μ΄λΈ”

-- νΈλμ­μ… A μ‹μ‘
START TRANSACTION;

-- νΈλμ­μ… A 1-3κ³Ό 3-5 μ‚¬μ΄μ κ°­κ³Ό 3 λ μ½”λ“ λ½ μ„¤μ •(λ„¥μ¤νΈν‚¤ λ½)
SELECT * FROM orders WHERE orders_id BETWEEN 2 AND 4 FOR UPDATE;

-- νΈλμ­μ… B μ‹μ‘
START TRANSACTION;

-- νΈλμ­μ… Bκ°€ id 4μ— λ°μ΄ν„° μ‚½μ… μ‹λ„ μ‹, κ°­ λ½μΌλ΅ μΈν•΄ μ‚½μ…μ΄ μ°¨λ‹¨λμ–΄ λ€κΈ°
INSERT INTO orders (orders_id, orders_amount) VALUES (4, 200);
...
```

## π¤·π»β€β™‚οΈ NextKey Lockμ΄λ€ λ¬΄μ—‡μΈκ°€μ”?
λ„¥μ¤νΈν‚¤ λ½μ€ λ μ½”λ“ λ½κ³Ό κ°­ λ½μ„ κ²°ν•©ν• ν•νƒλ΅, νΉμ • μΈλ±μ¤ λ μ½”λ“μ™€ κ·Έ μ£Όλ³€μ κ°­μ„ λ™μ‹μ— μ κ·Έλ” λ½μ…λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ λ μ½”λ“ μμ²΄μ λ³€κ²½κ³Ό ν•¨κ» κ·Έ μ£Όλ³€ κ³µκ°„μ λ³€κ²½λ„ λ™μ‹μ— μ μ–΄ν•  μ μμµλ‹λ‹¤.

λ„¥μ¤νΈν‚¤ λ½μ€ νΉμ • λ μ½”λ“μ™€ κ·Έ μ£Όλ³€ κ³µκ°„μ„ μ κ·ΈκΈ° λ•λ¬Έμ—, λ‹¤λ¥Έ νΈλμ­μ…μ΄ μƒλ΅μ΄ λ μ½”λ“λ¥Ό μ‚½μ…ν•μ—¬ ν¬ν…€ λ¦¬λ“λ¥Ό λ°μƒμ‹ν‚¤λ” κ²ƒμ„ λ°©μ§€ν•©λ‹λ‹¤.

| orders_id | orders_amount |
|-----------|---------------|
| 1         | 100           |
| 2         | 200           |
| 3         | 300           |

```sql
-- νΈλμ­μ… A μ‹μ‘
START TRANSACTION;

-- νΈλμ­μ… A amount = 200μΈ orders_id = 2 λ μ½”λ“μ— λ€ν• λ μ½”λ“ λ½κ³Ό 1-2, 2-3μ— λ€ν• κ°­ λ½μ„ λ™μ‹μ— μ κΈμΌλ΅μ¨ λ„¥μ¤νΈν‚¤ λ½μ„ μ„¤μ •
SELECT * FROM orders WHERE orders_amount = 200 FOR UPDATE;

-- νΈλμ­μ… B μ‹μ‘
START TRANSACTION;

-- νΈλμ­μ… B orders_id = 4, orders_amount = 200μΈ λ μ½”λ“ μ‚½μ… μ‹λ„ μ‹, λ„¥μ¤νΈν‚¤ λ½μΌλ΅ μΈν•΄ μ°¨λ‹¨λμ–΄ λ€κΈ°
INSERT INTO orders (orders_id, order_amount) VALUES (4, 200);
...
```

## π’΅ κ°­ λ½κ³Ό λ„¥μ¤νΈν‚¤ λ½μ„ ν†µν• ν¬ν…€ λ¦¬λ“ λ°©μ§€ λ©”μ»¤λ‹μ¦
νΈλμ­μ… Aκ°€ νΉμ • λ²”μ„μ λ°μ΄ν„°λ¥Ό μ΅°νν•  λ•, ν•΄λ‹Ή λ²”μ„μ— λ€ν•΄ κ°­ λ½ λλ” λ„¥μ¤νΈν‚¤ λ½μ„ μ„¤μ •ν•©λ‹λ‹¤. λ½μ΄ μ„¤μ •λ λ²”μ„ λ‚΄μ—μ„λ” νΈλμ­μ… Bκ°€ μƒλ΅μ΄ λ μ½”λ“λ¥Ό μ‚½μ…ν•κ±°λ‚ κΈ°μ΅΄ λ μ½”λ“λ¥Ό μμ •ν•λ” κ²ƒμ΄ μ°¨λ‹¨λ©λ‹λ‹¤. λ”°λΌμ„, νΈλμ­μ… Aκ°€ λ‹¤μ‹ λ™μΌν• μ΅°κ±΄μΌλ΅ μ΅°νλ¥Ό μν–‰ν•λ”λΌλ„, νΈλμ­μ… Bμ— μν•΄ μƒλ΅μ΄ λ°μ΄ν„°κ°€ μ‚½μ…λμ§€ μ•μ•„ ν¬ν…€ λ¦¬λ“κ°€ λ°μƒν•μ§€ μ•μµλ‹λ‹¤.