# Multi Server

다중 서버는 하나의 서비스를 여러 대의 서버로 분산하여 운영하는 환경을 의미합니다. 단일 서버의 한계를 극복하고 고가용성과 확장성을 확보하기 위한 아키텍처입니다.

## 🤷🏻‍♂️ 다중 서버 환경에서 세션 기반 인증 방식을 사용하는 경우 발생할 수 있는 문제점은 무엇인가요?

다중 서버 환경에서 세션 기반 인증 방식을 사용하는 경우에는 세션 불일치 문제가 발생할 수 있습니다. 

만약 서버 A, B를 관리하고 있을 때, 로드밸런서는 사용자의 요청을 상황에 맞게 A, B 중 한 곳으로 전달합니다. 유효한 로그인 요청이 A 서버로 처음 도착하면 사용자에 대한 세션 정보는 A 서버에 저장됩니다. 이후에 해당 사용자의 또 다른 요청이 로드 밸런서에 도착했을 때, B 서버로 도착하게 되면 사용자의 세션 데이터가 존재하지 않기 때문에 요청이 제대로 처리되지 않습니다. 이를 세션 불일치 문제라고 합니다.

## 🤷🏻‍♂️ 세션 불일치 문제는 어떻게 해결할 수 있나요?

세션 불일치 문제는 크게 3가지 방식으로 해결할 수 있습니다. 스티키 세션 방식, 세션 클러스터링 방식, 스토리지 분리 방식입니다.

### 스티키 세션 방식 

사용자 요청이 항상 사용자 세션 정보가 저장된 서버로 가도록 고정하는 방식입니다. 사용자 요청의 쿠키나 IP를 통해서 어느 서버로 고정 시킬지 결정합니다. 해당 방식은 단순하다는 장점이 존재합니다. 

반면, 특정 서버에 트래픽이 집중될 수 있다는 문제점과 사용자의 세션 정보를 가지고 있는 서버가 다운되면 해당 서버에 고정된 사용자는 다시 로그인해야하는 문제점이 존재합니다.

### 세션 클러스터링 방식 

특정 서버에 사용자 세션 정보가 생성될 때, 다른 서버로 정보를 복제하는 방식입니다. 여러 서버에 세션 정보를 중복으로 저장하므로 스티키 세션의 트래픽 몰림 현상과 세션 정보 유실 문제를 해결한다는 장점이 있습니다. 

반면, 세션 정보를 중복 저장한다는 점에서 메모리를 비효율적으로 사용하며, 세션 정보 복제 과정에서 발생하는 네트워크 트래픽 문제, 세션 정보 복제 지연으로 인한 일시적인 세션 정보 유실 문제가 발생할 수 있습니다.

### 스토리지 분리 방식 

세션 정보를 저장하는 공간을 외부로 분리하는 방식입니다. 세션 클러스터링 방식, 스티키 세션 방식에서 발생하는 문제를 해결할 수 있습니다. 

해당 방식은 스토리지에 대한 단일 장애 지점(Single Point Of Failure)이 문제가 될 수 있으며, 클러스터링과 같은 HA 구성으로 단일 장애 지점을 해소하여도 복제 지연으로 인한 일시적인 세션 정보 유실 문제는 발생할 수 있습니다. 또한, 외부 스토리지를 관리하기 위한 추가적인 리소스가 요구될 수 있습니다.

## 🤷🏻‍♂️ 그럼 다중 서버 환경에서 인증 방식을 어떤 식으로 해결하는게 좋을까요?

다중 서버 환경에서 인증 방식을 해결하는 가장 효과적인 방법은 JWT 토큰 기반 인증을 사용하는 것입니다.

### JWT 토큰 방식의 장점

**1. 서버 무상태성 (Stateless)**
- 서버에 세션 정보 저장 불필요
- 클라이언트가 토큰을 보관하므로 서버 간 동기화 문제 해결
- 어떤 서버로 요청이 가더라도 토큰 검증만으로 인증 처리

**2. 확장성**
- 서버 추가/제거가 자유로움
- 로드 밸런서가 자유롭게 요청 분산 가능
- 세션 클러스터링이나 스티키 세션 같은 복잡한 설정 불필요

**3. 성능**
- 서버 간 세션 복제 오버헤드 없음
- 외부 스토리지 조회 불필요
- 토큰 검증만으로 인증 처리 가능

## 💡 결론

*WT 토큰 방식이 다중 서버 환경에서 가장 권장되는 인증 방식입니다. 서버 무상태성과 확장성을 모두 만족하면서도 구현이 간단하기 때문입니다.

